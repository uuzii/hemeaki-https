<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/mp-slider/mp-slider.html">
<link rel="import" href="../bower_components/photo-gallery/photo-gallery.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html">
<!--link rel="import" href="../bower_components/photo-gallery/photo-gallery-icon.html"-->

<dom-module id="hemeaki-perfil">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
            }

            @media screen and (max-width: 600px) {
                :host {
                    min-height: calc(100vh - 106px);
                }
            }

            .container {
                text-align: center;
            }

            .thumbnail {
                height: 150px;
                width: 150px;
                text-align: center;
                display: inline-block;
            }

            .contact-item {
                display: inline-block;
                margin: 10px 0;
            }

            paper-button {
                background-color: white;
                color: #666;  
                font-size: 14px;
                text-transform: none;
                margin: 5px;
                border: 1px #666 solid;
                font-weight: bold;
            }

            iron-icon {
                height: 18px;
                width: 18px;
                margin-right: 6px;
            }

            iron-icon + a {
                font-size: 14px;
                margin: 6px;
            }

            .label {
                padding-right: 2px;
                font-size: 18px;
            }

            .tags-container {
                margin: 12px 0;
            }


            iron-image {
                display: block;
                background-color: white;
            }

            skeleton-carousel {
                min-height: 500px;
            }

            @media screen and (max-width: 600px) {
                iron-image {
                    display: block;
                    background-color: white;
                }

                skeleton-carousel {
                    min-height: 300px;
                }
            }

            paper-fab {
                position: fixed;
                right: 1em;
                bottom: 1em;
                background-color: #0087F7;
            }

            .deletebtn {
                margin-top: 3em;
                background-color: #E8172B;
                color: white;
                border: none;
            }

            .red-btn {
                margin: 0 5px;
                border: none;
            }
        </style>

        <app-route
            route="[[route]]"
            pattern="/:profile"
            data="{{routeData}}">
        </app-route>

        <iron-ajax
            auto 
            url="https://hemeaki-api.herokuapp.com/api/advertiser/{{routeData.profile}}"
            handle-as="json"
            last-response="{{perfil}}"
            on-response="parseTags"></iron-ajax>

        <iron-ajax
            auto 
            url="https://hemeaki-api.herokuapp.com/api/{{routeData.profile}}/images"
            handle-as="json"
            last-response="{{fotos}}"></iron-ajax>

        <iron-ajax
            id="deleteAjax"
            method="DELETE"
            handle-as="json"
            on-response="redirect"></iron-ajax>
        
        <iron-ajax
            id="deleteImagesAjax"
            method="DELETE"
            handle-as="json"
            on-error="errorDeleteImage"></iron-ajax>

        <app-localstorage-document key="userData" data="{{storedUser}}"></app-localstorage-document>

        <div class="container">
            
            <iron-image src="[[perfil.advertiser.0.avatar]]" class="thumbnail" preload sizing="contain"></iron-image>
            
            <h1>[[perfil.advertiser.0.name]]</h1>

            <p>[[perfil.advertiser.0.description]]</p>
            
            <a href="tel:[[perfil.advertiser.0.tel]]">
                <paper-button>
                    <iron-icon src="../assets/whatsapp-logo.png"></iron-icon>
                    [[perfil.advertiser.0.tel]]
                </paper-button>
            </a>

            <a href="mailto:[[perfil.advertiser.0.email]]">
                <paper-button>
                    <iron-icon icon="vaadin:at"></iron-icon>
                    [[perfil.advertiser.0.email]]
                </paper-button>
            </a>

            <a href="https://www.facebook.com/[[perfil.advertiser.0.facebookName]]/" target="_blank">
                <paper-button>
                    <iron-icon icon="vaadin:facebook"></iron-icon>
                    [[perfil.advertiser.0.facebookName]]
                </paper-button>
            </a>

            <br>

            <a href="https://www.google.com.mx/maps/place/[[perfil.advertiser.0.parsedAddress]]" target="_blank">
                <paper-button>
                    <iron-icon icon="communication:location-on"></iron-icon>
                    [[perfil.advertiser.0.address]]
                </paper-button>
            </a>
            
            <div class="tags-container">
                <template is="dom-repeat" items="{{tagsArray}}">
                    <paper-chip single-line>
                        <div slot="label" class="label" style="font-size: 14px">[[item]]</div>
                    </paper-chip>
                </template>
            </div>

            <photo-gallery>
                <template is='dom-repeat' items='[[fotos.images]]'>
                    <div class='item' data-url$='[[item.route]]'></div>
                </template>
            </photo-gallery>
            
            <a href="https://www.fb.com/msg/{{perfil.advertiser.0.facebookId}}" target="_blank">
                <paper-fab src="../assets/messenger.png"></paper-fab>
            </a>

            <br>
            <template is="dom-if" if="{{storedUser.loggedin}}">
                <paper-button raised class="deletebtn" on-tap="triggDialog">
                        <iron-icon icon="delete"></iron-icon>
                        Eliminar usuario
                </paper-button>
            </template>
            
        </div>

        <paper-dialog id="actions">
            <p>Â¿Seguro que dese eliminar la al anunciante '{{perfil.advertiser.0.name}}'?</p>
            <div class="buttons">
                <paper-button class="red-btn" dialog-dismiss>Cancelar</paper-button>
                <paper-button class="red-btn" for-slug="{{perfil.0.slug}}" on-tap="delete">Aceptar</paper-button>
            </div>
        </paper-dialog>

        

    </template>

    <script>

        class HemeakiPerfil extends Polymer.Element {

            static get is() {
                return 'hemeaki-perfil';
            }

            static get properties() {
                return {
                    tagsArray: {
                        type: Array
                    },
                    imgs: Array
                };
            }

            /**
             * Use for one-time configuration of your component after local DOM is initialized. 
             */
            ready() {
                super.ready();
            
                // When possible, use afterNextRender to defer non-critical
                // work until after first paint.
                Polymer.RenderStatus.afterNextRender(this, function() {
                    this.imgs = [
                        "https://firebasestorage.googleapis.com/v0/b/hemeaki-https.appspot.com/o/galleries%2FConstrucciones%20BLK%2F1508962131095-AZOTEA%201%20(1).jpg?alt=media&token=cd60aaf3-32bf-4c60-be39-714b93b8845f",
                        "https://firebasestorage.googleapis.com/v0/b/hemeaki-https.appspot.com/o/galleries%2FConstrucciones%20BLK%2F1508962131097-AZOTEA%202%20(2).jpg?alt=media&token=582c6cab-934d-4edd-a69d-0463f07fad08",
                        "https://firebasestorage.googleapis.com/v0/b/hemeaki-https.appspot.com/o/galleries%2FConstrucciones%20BLK%2F1508962131099-AZOTEA%203%20(2).jpg?alt=media&token=179e8d46-e7d4-4604-abc7-b8b022333ed6"
                    ]
                });
            
            }


            showRoute() {
                console.log(this.routeData);
            }

            consult(event) {
                var tags = event.detail.response[0].tags;
                this.array = tags.split(",");
                console.log(this.array);
            }

            triggDialog() {
                this.$.actions.open();
            }

            deleteImages() {
                var myImages = this.fotos.images;
                for (var index = 0; index < myImages.length; index++) {
                    var myId = myImages[index]._id
                    this.$.deleteImagesAjax.url = `https://hemeaki-api.herokuapp.com/api/image/${myId}`
                    this.$.deleteImagesAjax.generateRequest();
                }
            }

            delete() {
                this.deleteImages();
                const slug = this.perfil.advertiser[0].slug;
                this.$.deleteAjax.url = `https://hemeaki-api.herokuapp.com/api/advertiser/${slug}`
                this.$.deleteAjax.generateRequest();
            }
            
            redirect() {
                window.location = "/panel"
            }

            imprimir() {
                console.log(this.perfil.advertiser[0].tags.split(",").map(String));
            }

            parseTags() {
                this.tagsArray = this.perfil.advertiser[0].tags.split(",").map(String);
            }

            getImages(e) {
                console.log(this.fotos.images);
            }

            errorDeleteImage() {
                console.log('Error al eliminar imagen');
            }

        }

        window.customElements.define(HemeakiPerfil.is, HemeakiPerfil);
    </script>
</dom-module>